name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  #############################################################################
  # Test Job - Run tests for all microservices
  #############################################################################
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin@123
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create test databases
        run: |
          PGPASSWORD=admin@123 psql -h localhost -U postgres -c "CREATE DATABASE auth;"
          PGPASSWORD=admin@123 psql -h localhost -U postgres -c "CREATE DATABASE account;"
          PGPASSWORD=admin@123 psql -h localhost -U postgres -c "CREATE DATABASE transaction;"
          PGPASSWORD=admin@123 psql -h localhost -U postgres -c "CREATE DATABASE loan;"
          PGPASSWORD=admin@123 psql -h localhost -U postgres -c "CREATE DATABASE notification;"

      - name: Test Discovery Service
        run: |
          cd services/discovery
          mvn clean test

      - name: Test Config Server
        run: |
          cd services/config-server
          mvn clean test

      - name: Test Gateway Service
        run: |
          cd services/gateway
          mvn clean test

      - name: Test Auth Service
        run: |
          cd services/auth
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/auth
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: admin@123

      - name: Test Account Service
        run: |
          cd services/account
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/account
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: admin@123

      - name: Test Transaction Service
        run: |
          cd services/transaction
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/transaction
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: admin@123

      - name: Test Loan Service
        run: |
          cd services/loan
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/loan
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: admin@123

      - name: Test Notification Service
        run: |
          cd services/notification
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/notification
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: admin@123

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/target/surefire-reports/*.xml'

  #############################################################################
  # Build Job - Build Docker images for all services
  #############################################################################
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (optional)
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: Build Discovery Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/discovery
          push: false
          tags: online-banking-microservices-api-discovery:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Config Server
        uses: docker/build-push-action@v5
        with:
          context: ./services/config-server
          push: false
          tags: online-banking-microservices-api-config-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Gateway
        uses: docker/build-push-action@v5
        with:
          context: ./services/gateway
          push: false
          tags: online-banking-microservices-api-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth
          push: false
          tags: online-banking-microservices-api-auth-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Account Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/account
          push: false
          tags: online-banking-microservices-api-account-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Transaction Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/transaction
          push: false
          tags: online-banking-microservices-api-transaction-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Loan Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/loan
          push: false
          tags: online-banking-microservices-api-loan-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Notification Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification
          push: false
          tags: online-banking-microservices-api-notification-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  #############################################################################
  # Integration Test Job - Test the full stack
  #############################################################################
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start infrastructure services
        run: |
          docker-compose up -d postgresql mongodb kafka zookeeper
          sleep 30  # Wait for services to be ready

      - name: Verify PostgreSQL
        run: |
          docker exec ms_pg_sql pg_isready -U postgres
          docker exec ms_pg_sql psql -U postgres -lqt | cut -d \| -f 1 | grep -qw auth
          docker exec ms_pg_sql psql -U postgres -lqt | cut -d \| -f 1 | grep -qw account

      - name: Start core services
        run: |
          docker-compose up -d discovery config-server
          sleep 30

      - name: Start gateway
        run: |
          docker-compose up -d gateway
          sleep 20

      - name: Start business services
        run: |
          docker-compose up -d auth-service account-service transaction-service loan-service notification-service
          sleep 40

      - name: Check service health
        run: |
          curl -f http://localhost:8761 || exit 1
          curl -f http://localhost:8222/actuator/health || exit 1
          curl -f http://localhost:10070/actuator/health || exit 1
          curl -f http://localhost:10080/actuator/health || exit 1

      - name: Run smoke tests
        run: |
          # Test Swagger aggregator
          curl -f http://localhost:8222/swagger-aggregator.html || exit 1

          # Test service Swagger UIs
          curl -f http://localhost:8222/auth-service/swagger-ui/index.html || exit 1
          curl -f http://localhost:8222/account-service/swagger-ui/index.html || exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          docker-compose logs --tail=100

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

  #############################################################################
  # Deploy Job - Deploy to VPS (only on main branch)
  #############################################################################
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to VPS
        run: |
          rsync -avz --exclude='.git' --exclude='target' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_DEPLOY_PATH }}/

      - name: Deploy on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_DEPLOY_PATH }}

            # Make scripts executable
            chmod +x setup.sh cleanup.sh

            # Run cleanup
            ./cleanup.sh --remove

            # Run setup
            ./setup.sh

            # Verify deployment
            sleep 30
            curl -f http://localhost:8222/actuator/health || exit 1
          EOF

      - name: Deployment notification
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
            exit 1
          fi
